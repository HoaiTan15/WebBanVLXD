@model WebBanVLXD.Models.SANPHAM
@{
    Layout = "~/Views/Shared/_LayoutShop.cshtml";
    ViewBag.Title = Model.TenSP;
}

<!-- BREADCRUMB -->
<div class="container mt-3 mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-white px-3 py-2 rounded-3 shadow-sm">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "SanPham")" class="text-decoration-none text-primary">VLXD Store</a>
            </li>
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "SanPham", new { madm = ViewBag.MaDanhMuc })" class="text-decoration-none text-primary">
                    @ViewBag.TenDanhMuc
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                @Model.TenSP
            </li>
        </ol>
    </nav>
</div>

<div class="container my-4">
    <div class="row g-4 bg-white p-4 shadow-sm rounded-3">

        <!-- ẢNH SẢN PHẨM -->
        <div class="col-md-5">
            <img src="~/@Model.HinhAnh" alt="@Model.TenSP" class="img-fluid rounded-3 border" />
            <div class="d-flex mt-3 gap-2">
                <img src="~/@Model.HinhAnh" class="img-thumbnail" style="width:70px;height:70px;object-fit:cover;" />
                <img src="~/@Model.HinhAnh" class="img-thumbnail" style="width:70px;height:70px;object-fit:cover;" />
                <img src="~/@Model.HinhAnh" class="img-thumbnail" style="width:70px;height:70px;object-fit:cover;" />
            </div>
        </div>

        <!-- THÔNG TIN SẢN PHẨM -->
        <div class="col-md-7">

            <div class="d-flex align-items-center gap-3">
                <h4 class="fw-bold mb-0">@Model.TenSP</h4>

                @if (Model.TrangThai != "HoatDong" || Model.SoLuongTon <= 0)
                {
                    <span class="badge bg-secondary">Ngừng kinh doanh</span>
                }
            </div>

            <div class="bg-light p-3 rounded-3 mb-3 mt-3">
                <span class="fs-4 text-danger fw-bold">
                    @string.Format("{0:N0} đ", Model.DonGia)
                </span>
            </div>

            <div class="mb-3">
                <strong>Đơn vị tính:</strong> @Model.DonViTinh
            </div>

            <div class="mb-3">
                <strong>Còn lại:</strong> @Model.SoLuongTon sản phẩm
            </div>

            <div class="mb-3">
                <strong>Mô tả:</strong>
                <p class="text-muted mt-2">@Model.MoTa</p>
            </div>

            <!-- SỐ LƯỢNG -->
            <div class="d-flex align-items-center mb-4">
                <label class="me-3 fw-semibold">Số lượng:</label>
                <div class="input-group" style="width:130px;">
                    <button class="btn btn-outline-secondary" type="button" id="minus">-</button>
                    <input type="number" id="quantity" class="form-control text-center" value="1" min="1" />
                    <button class="btn btn-outline-secondary" type="button" id="plus">+</button>
                </div>
            </div>

            @if (Model.TrangThai != "HoatDong" || Model.SoLuongTon <= 0)
            {
                <button class="btn btn-secondary w-100 py-3" disabled>Ngừng kinh doanh</button>
            }
            else if (Session["Role"] != null &&
                     (Session["Role"].ToString() == "admin" || Session["Role"].ToString() == "quanly"))
            {
                <!-- Ẩn mua hàng cho admin và quản lý -->
                <div class="alert alert-warning mt-3">
                    Tài khoản quản trị không thể mua hàng.
                </div>
            }
            else
            {
                <div class="d-flex gap-3">

                    <!-- NÚT THÊM GIỎ HÀNG -->
                    <button class="btn btn-outline-danger px-4"
                            onclick="addToCart('@Model.MaSP')">
                        <i class="fa fa-cart-plus"></i> Thêm vào giỏ hàng
                    </button>

                    <!-- MUA NGAY -->
                    <form method="post" action="@Url.Action("MuaNgay", "KhachHang")">
                        <input type="hidden" name="MaSP" value="@Model.MaSP" />
                        <input type="hidden" id="BuyNowQty" name="SoLuong" value="1" />
                        <button type="submit" class="btn btn-danger px-4">Mua ngay</button>
                    </form>
                </div>
            }

        </div>
    </div>
</div>

<!-- SCRIPT SỐ LƯỢNG -->
<script>
    const qtyInput = document.getElementById("quantity");
    const buyNowQty = document.getElementById("BuyNowQty");

    document.getElementById("plus").addEventListener("click", function () {
        qtyInput.value = parseInt(qtyInput.value) + 1;
        buyNowQty.value = qtyInput.value;
    });

    document.getElementById("minus").addEventListener("click", function () {
        if (qtyInput.value > 1) {
            qtyInput.value = parseInt(qtyInput.value) - 1;
            buyNowQty.value = qtyInput.value;
        }
    });

    qtyInput.addEventListener("input", function () {
        let qty = parseInt(qtyInput.value);
        if (isNaN(qty) || qty <= 0) qty = 1;

        qtyInput.value = qty;
        buyNowQty.value = qty;
    });
</script>

<!-- AJAX THÊM GIỎ -->
<script>
    function addToCart(maSP) {
        const soLuong = parseInt(document.getElementById("quantity").value);

        $.ajax({
            url: '/KhachHang/ThemVaoGio',
            type: 'POST',
            data: {
                MaSP: maSP,
                SoLuong: soLuong
            },

            success: function (res) {

                if (res.requireLogin) {
                    window.location.href = "/Account/Login";
                    return;
                }

                if (res.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã thêm vào giỏ!',
                        text: res.message,
                        timer: 1500,
                        showConfirmButton: false
                    });

                    $("#cart-count").text(res.cartCount);

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: res.message
                    });
                }
            },

            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi hệ thống!',
                    text: 'Không thể thêm sản phẩm!'
                });
            }
        });
    }
</script>

<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
</style>
